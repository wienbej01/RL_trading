# Technical Overview

This document provides a technical overview of the RL Intraday Trading System.

## 1. System Intent & Boundaries

The system is a reinforcement learning-based trading platform for intraday futures trading, specifically targeting E-mini S&P 500 (MES) contracts. It is designed to be a complete end-to-end solution, from data collection and feature engineering to model training, backtesting, and paper trading.

**In Scope:**

*   Data collection from Polygon.io.
*   Feature engineering pipeline.
*   RL model training (PPO with LSTM).
*   Walk-forward validation.
*   Backtesting and evaluation.
*   Paper trading with Interactive Brokers.

**Out of Scope:**

*   Live trading with real money.
*   Support for other data providers out-of-the-box (though the system is extensible).
*   Advanced order execution logic (e.g., TWAP/VWAP execution).

## 2. Architecture Overview

The system is composed of several interconnected modules that handle different aspects of the trading pipeline.

```
[ Polygon.io ] -> [ Data Loader ] -> [ Feature Pipeline ] -> [ RL Environment ] -> [ PPO Model ]
      ^                   |
      |                   v
      +-----------[ IBKR Gateway ] <- [ Execution Engine ] <- [ Backtest/Paper Trading ] <-+
```

*   **Data Loader:** Responsible for fetching historical and real-time data from Polygon.io. See `src/data/data_loader.py`.
*   **Feature Pipeline:** Generates a rich set of features from the raw data, including technical indicators and microstructure features. See `src/features/pipeline.py`.
*   **RL Environment:** A custom OpenAI Gym-compatible environment for training the RL agent. See `src/sim/env_intraday_rl.py`.
*   **PPO Model:** The reinforcement learning agent, based on Proximal Policy Optimization (PPO) with an LSTM policy. See `src/rl/ppo_lstm_policy.py`.
*   **Execution Engine:** Simulates order execution for backtesting and paper trading. See `src/sim/execution.py`.
*   **Backtest/Paper Trading:** The main entry points for running simulations and paper trading sessions. See `examples/polygon_rl_backtest_example.py` and `scripts/run_paper_trading.py`.

## 3. Data Pipeline

*   **Sources:** The primary data source is Polygon.io, providing historical and real-time market data.
*   **Schema:** The data is stored in Parquet files, partitioned by symbol, year, month, and day. The schema includes OHLCV data, as well as VWAP and transaction counts from Polygon.
*   **Caches:** The system uses a caching mechanism to store pre-processed data and features, reducing the need for repeated computations. The cache is located at `data/cache/`.
*   **Artifacts:**
    *   Raw data is stored in `data/polygon/historical/`.
    *   Aggregated data is stored in `data/raw/`.
    *   Generated features are stored in `data/features/`.
    *   Trained models are saved in `models/`.

## 4. Training / Backtest Flow

### Training

The training process is initiated via the `src/rl/train.py` script.

**CLI Example:**

```bash
PYTHONPATH=/home/jacobw/RL_trading/rl-intraday python -m src.rl.train \
  --config /home/jacobw/RL_trading/rl-intraday/configs/settings.yaml \
  --data data/raw/spy_1min.parquet \
  --features data/features/SPY_features.parquet \
  --output /home/jacobw/RL_trading/rl-intraday/models/trained_model
```

**Key Configuration (`configs/settings.yaml`):**

*   `train`: Hyperparameters for the PPO agent.
*   `features`: Configuration for the feature engineering pipeline.
*   `walkforward`: Parameters for walk-forward validation.

### Backtesting

Backtesting is performed using the `examples/polygon_rl_backtest_example.py` script.

**CLI Example:**

```bash
python /home/jacobw/RL_trading/rl-intraday/examples/polygon_rl_backtest_example.py \
  --symbol SPY \
  --start-date 2024-01-01 \
  --end-date 2025-06-30 \
  --episodes 10 \
  --model-path /home/jacobw/RL_trading/rl-intraday/models/trained_model.zip
```

## 5. Environments

*   **Virtual Environment:** A local Python virtual environment is located at `/home/jacobw/RL_trading/rl-intraday/venv`.
*   **PYTHONPATH:** The `rl-intraday` directory must be added to the `PYTHONPATH` to ensure that the modules can be found.
*   **Dependencies:** Key dependencies include `stable-baselines3`, `torch`, `pandas`, `numpy`, and `polygon-api-client`. A full list can be found in `requirements.txt`.

## 6. Observability

*   **Logs:** Logs are generated by the various scripts and are printed to the console. The `end_to_end_test.log` file in the root directory contains detailed logs of the test runs.
*   **Metrics:** The backtesting script outputs a summary of performance metrics, including total return, win rate, and Sharpe ratio.
*   **Reports:** The backtesting script can generate a plot of the backtest results, which is saved as `backtest_results_{symbol}.png`.
*   **Tensorboard:** The training script logs data to Tensorboard, which can be found in the `runs/tensorboard` directory.

## 7. Known Constraints & Risks

1.  **PYTHONPATH Requirement:** The `rl-intraday` directory must be added to the `PYTHONPATH` for the scripts to run correctly.
2.  **Data Aggregation:** The training script requires a single data file, but the data is downloaded in partitioned files. The `scripts/aggregate_spy_data.py` script must be run to aggregate the data.
3.  **Backtesting Script:** The provided backtesting script uses random actions by default and needs to be modified to load and use a trained model.
4.  **Model Performance:** The model currently does not perform well and requires further tuning and development.
5.  **Data Gaps:** The data from Polygon.io may contain gaps, which can affect the quality of the features and the performance of the model.

## 8. Glossary

*   **PPO:** Proximal Policy Optimization, the reinforcement learning algorithm used in this project.
*   **LSTM:** Long Short-Term Memory, a type of recurrent neural network used in the policy.
*   **Walk-Forward Validation:** A method for testing the performance of a trading strategy on historical data that avoids lookahead bias.
*   **Sharpe Ratio:** A measure of risk-adjusted return.
*   **Max Drawdown:** The maximum observed loss from a peak to a trough of a portfolio.
*   **OHLCV:** Open, High, Low, Close, Volume - the standard data points for a financial instrument.
*   **VWAP:** Volume-Weighted Average Price.
*   **RTH:** Regular Trading Hours.
*   **IBKR:** Interactive Brokers, the supported broker for paper and live trading.
*   **TWS:** Trader Workstation, the trading platform from Interactive Brokers.
